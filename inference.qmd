---
title: "inference"
author: 
- Marcelo Atanasio Domínguez Mateo
- Arminda García Moreno
- Alejandro García Prada

date: today
format: 
  html:
    toc: true
    theme: cosmo
    code-tools: 
      source: true
  
execute:
  warning: false
  echo: true
---

```{r, echo=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(psych)
library(summarytools)
library(knitr)
library(kableExtra)
library(MASS)
library(GGally)
library(nortest)
```

# Objetivos

# Metodología

# Preparación de los datos

::: {.callout-note collapse="true" title="Código"}
```{r}
df <- read.table(file = "data/lucanus.csv", header = TRUE, fill = TRUE)

df <- df |>
  mutate(
      KB = as.numeric(gsub(",", ".", trimws(KB))),
      EL = as.numeric(gsub(",", ".", trimws(EL))),
      SEXO = as.factor(trimws(SEXO)),
      PROVINCIA = ifelse(trimws(PROVINCIA) == "", "Otras", trimws(PROVINCIA)),
      PROVINCIA = as.factor(trimws(PROVINCIA))
  )

summary(df)
```
:::

Se comenzó con el procesamiento y limpieza de los datos de los 265 ejemplares de Lucanus cervus. Para cada individuo se registraron la anchura de la cabeza (KB), la longitud de los élitros (EL), el sexo y la provincia de procedencia (Asturias, Cantabria u otras). Se verificaron los formatos de las variables, se corrigieron inconsistencias y se prepararon los datos para el análisis posterior.

Los intervalos de confianza y los contrastes de hipótesis para medias (y diferencia de medias) basados en la t-student asumen que las muestras provienen de poblaciones distribuidas en una normal. Cuando este supuesto no se cumple y la muestra es grande ($n \geq 30$), se puede aplicar el Teorema Central del Límite y asumir que la distribución de las medias se aproxima a una normal.

En nuestro caso, se ha comprobado si las muestras de KB y EL siguen distribuciones normales con el test no paramétrico de Lilliefors. 

::: {.callout-note collapse="true" title="Código"}
```{r}
lillie.test(df$KB)
```
:::

::: {.callout-note collapse="true" title="Código"}
```{r}
lillie.test(df$EL)
```
:::

Se observa que en el caso de EL no puede rechazarse la hipótesis de normalidad, pero en el caso de KB sí. En este último caso, el teorema central del límite posibilita la comparación de medias entre sexos y entre provincias.

# Análisis Estadístico
## 1. ¿Entre qué valores fluctúa el promedio de la anchura de la cabeza y de la longitud de los élitros del Lacanus Cervus?
```{r, echo=FALSE}
t.test(df$KB, data = df) # Armin Note: with one variable, do not put var.equal
```

```{r, echo=FALSE}
t.test(df$EL, data = df) # Armin Note: with one variable, do not put var.equal
```

## 2. ¿Existe diferencia estadísticamente significativa entre el promedio de la anchura de la cabeza y la longitud de los élitros según sexo?
[Armin Note: antes de hacer los test meter un boxplot que muestre machos-hembras para complementar lo que se va a ver en el test (no hace falta explicación super al detalle)]

[Armin Note: dejar esto de por qué no hacemos var.test en KB] Como la muestra de KB no ha pasado el test de normalidad se pone directamente `var.equal = FALSE` en las opciones de `t.test`, ya que el test de varianzas `var.test` requiere normalidad de los datos.
```{r, echo=FALSE}
t.test(df$KB ~ df$SEXO, data = df, var.equal = FALSE)  
```

[Armin Note: dejar esto que es la explicación del var.test para saber si poner en el t.test var.equal false or true] Como la muestra de EL ha pasado el test de normalidad, para comparar las medias por sexos, primero se hace un test de varianzas para saber si las varianzas se pueden considerar iguales. Como el p-valor de este test sale muy pequeño, se pone `var.equal = FALSE` en las opciones de `t.test`.

```{r, echo=FALSE}
t.test(df$EL ~ df$SEXO, data = df, var.equal = FALSE)
```

## 3. ¿Existe diferencia estadísticamente significativa entre el promedio de la anchura de la cabeza y la longitud de los élitros según si habitan en Cantabria o en Asturias?
Con el objetivo de evaluar si existen diferencias morfológicas entre individuos procedentes de Cantabria y Asturias, se analizan la anchura de la cabeza (KB) y la longitud de los élitros (EL).

Previamente a los contrastes de hipótesis, se exploran visualmente las distribuciones mediante diagramas de caja, con el fin de complementar la interpretación de los resultados inferenciales.

```{r, echo=FALSE}
df_sub <- subset(df, PROVINCIA %in% c("Cantabria", "Asturias"))
```

```{r, echo=FALSE}
ggplot(df_sub, aes(x = PROVINCIA, y = KB, fill = PROVINCIA)) +
  geom_boxplot() +
  labs(title = "Anchura de la cabeza (KB) por provincia",
        x = "Provincia", y = "Anchura de la cabeza (KB)") +
  theme_minimal()
``` 

```{r, echo=FALSE}
ggplot(df_sub, aes(x = PROVINCIA, y = EL, fill = PROVINCIA)) +
  geom_boxplot() +
  labs(title = "Longitud de los Élitros (EL) por provincia",
        x = "Provincia", y = "Longitud de los Élitros (EL)") +
  theme_minimal()
``` 
Desde el punto de vista descriptivo, ambas variables presentan valores medios ligeramente superiores en Cantabria; no obstante, se observa una superposición considerable entre las distribuciones, lo que sugiere que las diferencias podrían no ser estadísticamente relevantes.

## Contrastes de hipótesis para la comparación entre provincias
### Anchura de la cabeza (KB)

[Armin Note: dejar esto de por qué no hacemos var.test en KB]

La variable KB no cumple el supuesto de normalidad. En este contexto, no resulta apropiado aplicar un test formal de igualdad de varianzas, ya que el contraste clásico de varianzas asume normalidad. Sin embargo, dado el tamaño muestral elevado, la inferencia sobre la media puede abordarse mediante un contraste t apoyado en el Teorema Central del Límite, que garantiza la aproximación normal de la distribución de la media muestral.

Por tanto, se emplea directamente el test t de Welch, que no asume igualdad de varianzas y es más robusto frente a desviaciones de normalidad:

```{r, echo=FALSE}
t.test(df_sub$KB ~ df_sub$PROVINCIA, data = df_sub, var.equal = FALSE)
```
El contraste no permite rechazar la hipótesis nula de igualdad de medias al nivel de significación `\alpha = 0.05`. Aunque la media de KB es ligeramente mayor en Cantabria, la diferencia observada no es estadísticamente significativa.

### Longitud de los élitros (EL)

[Armin Note: dejar esto que es la explicación del var.test para saber si poner en el t.test var.equal false or true]

```{r, echo=FALSE}
var.test(df$EL~ df$SEXO)
# small p-value --> var.equal = FALSE
```

En el caso de EL, la variable sí cumple el supuesto de normalidad, lo que permite evaluar previamente la homogeneidad de varianzas entre provincias. El test de igualdad de varianzas resulta significativo, indicando varianzas desiguales entre grupos. En consecuencia, se utiliza nuevamente el test t de Welch para comparar las medias:

```{r, echo=FALSE}
t.test(df_sub$EL ~ df_sub$PROVINCIA, data = df_sub, var.equal = FALSE)
```
El resultado del contraste tampoco permite rechazar la hipótesis nula al nivel $\alpha = 0.05$. Al igual que en KB, Cantabria presenta valores medios ligeramente superiores, pero la evidencia estadística no es suficiente para afirmar la existencia de una diferencia poblacional real.

### Comparación global entre provincias

Finalmente, se amplía el análisis a todas las provincias mediante un ANOVA de un factor, tanto para KB como para EL:

```{r, echo=FALSE}
anova_mod <- aov(KB ~ PROVINCIA, data = df)
summary(anova_mod)
```

```{r, echo=FALSE}
anova_mod <- aov(EL ~ PROVINCIA, data = df)
summary(anova_mod)
```

En ninguno de los dos casos se detectan diferencias estadísticamente significativas entre provincias, lo que es consistente con los resultados obtenidos en la comparación específica entre Asturias y Cantabria.


[Marcenota: esto si queréis pasadlo a la conclusión]

Entre Asturias y Cantabria, las medias de la anchura de la cabeza (KB) y de la longitud de los élitros (EL) son ligeramente mayores en Cantabria; sin embargo, ninguna de estas diferencias resulta estadísticamente significativa. Al extender el análisis al conjunto de provincias, esta ausencia de diferencias significativas se mantiene. En consecuencia, no se dispone de evidencia estadística suficiente para afirmar que la morfología media de Lucanus cervus difiera en función de la provincia considerada.

## 4. Suponiendo que la muestra es representativa de la población, ¿los hábitats son igual de numerosos en Cantabria y Asturias?, ¿y en términos de sexo?

```{r, echo=FALSE}
table(df_sub$PROVINCIA)
```

Como se supone que la muestra es representativa de la población, si $p_A$ es la proporción de escarabajos de Asturias y $p_C$ los de Cantabria, la única forma de que fueran iguales es $p_A = p_C = 0.5$. Para contrastar esta hipótesis, se realiza un test para comprobar si una proporción, por ejemplo, la de Asturias es igual a 0.5 frente a la hipótesis alternativa de que es mayor. En este caso, se supone una distribución binomial donde el éxito es que el escarabajo pertenezca a Asturias y el fallo es que pertenezca a Cantabria.

::: {.callout-note collapse="true" title="Código"}
```{r}
# Cantabria and Asturias study
prop.test(x = 180, n = 208, alternative = "greater", conf.level = 0.95)
```
:::

La hipótesis nula $H_0: p_A = 0.5$ es rechazada debido a que el p-valor obtenido es mucho más pequeño que el nivel de significación $\alpha = 0.05$ frente a la alternativa $H_1: p_A > 0.5$. Por lo tanto, si $p_A$ es mayor a 0.5, $p_C$ debe ser menor (ya que es su complementario) y el hábitat de Asturias es más numeroso que el de Cantabria.

Para estudiar la distribución de géneros entre los escarabajos comenzamos estudiando la proporción de machos en la muestra completa de 265 especímenes. Para ello, se realiza un test de proporciones en la que el éxito será "ser macho" y se desea ver si esta proporción es igual a 0.5.

```{r, echo=FALSE}
table(df$SEXO)
```

::: {.callout-note collapse="true" title="Código"}
```{r}
# By sex on the whole sample
prop.test(x = 142, n = 265, alternative = "two.sided", conf.level = 0.95)
```
:::

En este caso, para este contraste $H_0: p_M = 0.5$ frente a $H_1: p_M \neq 0.5$ se obtiene un p-valor de 0.2688. Por lo tanto, al ser mucho mayor que el nivel de significancia $\alpha$, se concluye que las proporciones de machos y hembras son iguales en la población global (Asturias, Cantabria y otras).

Si nos centramos en las provincias de Asturias y Cantabria se puede realizar un test para comprobar si son iguales las proporciones de escarabajos machos en ambas provincias. En Asturias se han observado 97 machos de un total de 180 escarabajos y en Cantabria se han observado 18 machos de un total de 28 escarabajos. Se supone que $p_{MA}$ es la proporción poblacional de escarabajos machos en Asturias y $p_{MC}$ la proporción de machos en Cantabria.

```{r, warnings=FALSE,echo=FALSE}
df_sub %>% group_by(PROVINCIA,SEXO) %>% summarise(n=n(), .groups="drop_last") %>% mutate(n_prov=sum(n))
```

::: {.callout-note collapse="true" title="Código"}
```{r}
# By sex on the subset (Asturias and Cantabria only)
prop.test(x = c(97,18), n = c(180,28), alternative = "two.sided", conf.level = 0.95)
```
:::

El p-valor del contraste $H_0: p_{MA} = p_{MC}$ frente a $H_1: p_{MA} \neq p_{MC}$ es 0.4093. Al ser mucho mayor que el nivel de significación 0.05, no existen evidencias suficientes para rechazar que la proporción de machos es la misma en Asturias y en Cantabria.

# Conclusiones