---
title: "Estudio de datos biométricos sobre Lucanus Cervus"
author: 
- Marcelo Atanasio Domínguez Mateo
- Arminda García Moreno
- Alejandro García Prada

date: today
format: 
  html:
    toc: true
    theme: cosmo
  pdf:
    documentclass: article
    number-sections: true
    titlepage: false
    toc-location: before-body
    include-in-header: _extensions/tocdots/tocdots.tex
    toc: true
    toc-title: "Índice"
    geometry:
      - margin=25mm
execute:
  warning: false
  echo: true
---
```{r, echo=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(psych)
library(summarytools)
library(knitr)
library(kableExtra)
```

## Objetivos del estudio

El presente estudio se centra en el análisis biométrico del ciervo volante (Lucanus cervus), el mayor escarabajo de Europa, cuya población se ve amenazada por la destrucción de su hábitat natural, los bosques con abundante madera muerta. Este análisis tiene un doble interés: por un lado, evaluar posibles diferencias de tamaño entre machos y hembras; por otro, explorar la relación entre el tamaño de los individuos y la calidad del hábitat de procedencia, ya que se sospecha que en áreas con mayor disponibilidad y calidad de madera muerta los ejemplares alcanzan un mayor desarrollo.

En este marco, el estudio se centra en la medición de la anchura de la cabeza y la longitud de los élitros en un total de 265 ejemplares, seleccionando una muestra representativa de 150 individuos. Se pretende realizar un análisis descriptivo de la anchura de la cabeza, destacando sus principales características y distribuciones dentro de la muestra.

Además, se comparará la anchura de la cabeza entre machos y hembras para identificar diferencias morfológicas relacionadas con el sexo. De manera complementaria, se evaluará si existen variaciones significativas entre ejemplares de distintas procedencias (Asturias, Cantabria y otra), lo que permitirá analizar la influencia del origen geográfico y, por extensión, del hábitat sobre el tamaño de los individuos.

Otro objetivo fundamental es analizar la correlación entre la anchura de la cabeza y la longitud del élitro, primero considerando toda la muestra y posteriormente separando por sexo. Este análisis permitirá determinar si existe una relación proporcional entre estas dos medidas y si dicha relación varía entre hembras y machos.

Finalmente, en los casos en que se identifique una relación significativa entre la anchura de la cabeza y la longitud del élitro para algún sexo, se ajustará un modelo de regresión lineal que explique la variación de la anchura de la cabeza en función de la longitud del élitro, con el objetivo de interpretar cuantitativamente esta relación morfológica y su relevancia biológica.

## Metodología

El estudio se realizó utilizando ejemplares de la colección entomológica del Departamento de Biología de Organismos y Sistemas de la Universidad de Oviedo, incluyendo un total de 265 individuos de ciervo volante (Lucanus cervus), tanto machos como hembras, provenientes de Asturias, Cantabria y otras zonas. Para cada ejemplar se registraron la anchura de la cabeza (KB) y la longitud del élitro (EL) en milímetros, así como el sexo y la provincia de procedencia.

Se seleccionó una muestra aleatoria de 150 individuos para el análisis descriptivo, asegurando que la muestra reflejara adecuadamente la variabilidad de la población. Los datos fueron previamente limpiados y transformados: los valores numéricos fueron convertidos a formato adecuado, se corrigieron inconsistencias y se clasificó la procedencia de los ejemplares en tres categorías: Asturias, Cantabria y otras.

El análisis estadístico incluyó la obtención de medidas de tendencia central y de dispersión para la anchura de la cabeza y la longitud del élitro, con el fin de caracterizar la muestra. Se realizaron comparaciones de la anchura de la cabeza entre machos y hembras y entre ejemplares de distintas procedencias mediante tablas de frecuencia, gráficos de barras, boxplots y violín plots.

Se analizó la relación entre la anchura de la cabeza y la longitud del élitro mediante coeficientes de correlación para toda la muestra y por sexo, con el objetivo de identificar posibles asociaciones morfológicas. En los casos en los que se detectó una correlación significativa, se ajustó un modelo de regresión lineal para explicar la variación de la anchura de la cabeza en función de la longitud del élitro y se interpretaron los parámetros obtenidos en términos biológicos.

Para la visualización de los datos y la generación de gráficos se utilizó el software R, empleando principalmente los paquetes ggplot2 y summarytools. Se elaboraron histogramas, boxplots, violín plots y tablas descriptivas que permitieron explorar la distribución de las variables, identificar diferencias entre grupos y mostrar la relación entre la anchura de la cabeza y la longitud del élitro de manera clara y reproducible.

## Resultados
### Análisis descriptivo de todos los ejemplares
```{r, echo=FALSE}
lab <- read.table(file = "data/lucanus.csv", header = TRUE, fill = TRUE)

lab <- lab |>
  mutate(
      KB = as.numeric(gsub(",", ".", trimws(KB))),
      EL = as.numeric(gsub(",", ".", trimws(EL))),
      SEXO = as.factor(trimws(SEXO)),
      PROVINCIA = ifelse(trimws(PROVINCIA) == "", "Otras", trimws(PROVINCIA)),
      PROVINCIA = as.factor(trimws(PROVINCIA))
  )

summary(lab)
```
Se comenzó con el procesamiento y limpieza de los datos de los 265 ejemplares de Lucanus cervus. Para cada individuo se registraron la anchura de la cabeza (KB), la longitud de los élitros (EL), el sexo y la provincia de procedencia (Asturias, Cantabria u otras). Se verificaron los formatos de las variables, se corrigieron inconsistencias y se prepararon los datos para el análisis posterior.

### Análisis descriptivo de una muestra de 150 ejemplares
```{r, echo=FALSE}
set.seed(42)
df <- lab |> 
  slice_sample(n = 150, replace = FALSE)
summary(df)
```
Para realizar un análisis más detallado, se seleccionó aleatoriamente una muestra de 150 ejemplares a partir de los 265 disponibles, asegurando que se conservara la variabilidad de la población original en términos de sexo, procedencia y medidas morfológicas.

En esta muestra, la anchura de la cabeza (KB) presentó valores entre 7,20 y 22,90 mm, con una mediana de 10,90 mm y un promedio de 11,95 mm, ligeramente inferior al promedio de toda la población (12,04 mm) pero similar en su mediana (10,70 mm). La longitud de los élitros (EL) varió entre 15,30 y 27,80 mm, con una mediana de 20,60 mm y una media de 20,72 mm, valores próximos a los observados en todos los ejemplares (mediana 20,70 mm, media 20,91 mm).

En cuanto al sexo, la muestra incluyó 67 hembras y 83 machos, manteniendo una proporción similar a la de la población completa. Respecto a la procedencia, 105 ejemplares eran de Asturias, 17 de Cantabria y 28 de otras zonas, reflejando también la distribución general de los 265 individuos.

Comparando esta muestra con la población total, se observa que las medidas de tendencia central y la dispersión se conservan, lo que confirma que la muestra es representativa y adecuada para los análisis posteriores. La selección aleatoria permite que los resultados de esta muestra reflejen fielmente las características morfológicas y la variabilidad de la especie en el conjunto de la colección.
```{r, echo=FALSE}
summary(df$KB)
```
### Análisis de la anchura de la cabeza
```{r, echo=FALSE}
  ggplot(df, aes(x = KB)) +
    geom_histogram(binwidth = 0.5, fill = "skyblue",color = "black") +
    labs(title = "Head Width Distribution",
         x = "Head Width (KB)",
         y = "Frequency")
```

```{r, echo=FALSE}
ggplot(df, aes(y = KB)) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = "Boxplot de Head Width",
       y = "Head Width (KB)")
```

### Comparación de la Cabeza entre las Provincias
Se agrupan los valores de KB en su parte entera para mejor legibilidad de los datos
```{r, echo=FALSE}
lab$KB_int <- floor(lab$KB)
pastel_colors <- c(
  "#E0F7FF", "#D1F0FF", "#C2E9FF", "#B3E2FF", "#A4DBFF", "#95D4FF", "#86CDFF", "#77C6FF", "#68BFFF", "#59B8FF", "#4AAFFF", "#3BA8FF", "#2CA1FF", "#1D9AFF", "#0E93FF", "#008CFF", "#007FCC", "#0073A6"
)
```

```{r, echo=FALSE}
tabla_contingencia <- summarytools::ctable(lab$KB_int, lab$PROVINCIA)
tabla_contingencia
```

```{r, echo=FALSE}
lab |>
  ggplot(aes(x = PROVINCIA, fill = factor(KB_int))) +
  geom_bar(position = position_dodge(), color = "black") +
  scale_fill_manual(values = pastel_colors) +
  theme_bw() +
  labs(
    x = "Province",          
    y = "Count",             
    fill = "KB Value"    
  )
```


```{r, echo=FALSE}
lab |>
  ggplot(aes(x = PROVINCIA, y = KB, fill = PROVINCIA)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.6) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.3) +
  scale_fill_manual(values = pastel_colors[c(4,8,12)]) +
  theme_bw() +
  labs(
    x = "Province",
    y = "Head Width (KB)",
    title = "Comparison of head width between provinces",
    fill = "Province"
  )
```
La línea negra representa la mediana de los datos

```{r, echo=FALSE}
ggplot(lab, aes(x = PROVINCIA, y = KB_int, fill = PROVINCIA)) +
  geom_violin(trim = FALSE, color = "black", alpha = 0.6) + 
  geom_jitter(width = 0.15, size = 1.5, alpha = 0.3, color = "black") +  # points
  scale_fill_manual(values = pastel_colors[c(4,8,12)]) +
  theme_bw() +
  labs(
    x = "Province",
    y = "Head Width (KB)",
    title = "Violin Plot of KB by Province",
    fill = "Province"
  )

```

```{r, echo=FALSE}
with(
  df, 
  stby(
    KB, 
    PROVINCIA, 
    descr
  )
)
```


### Comparar la anchura de la cabeza de las hembras con la de los machos.
```{r, echo=FALSE}
breaks <- seq(floor(min(df$KB)), ceiling(max(df$KB)), by = 1)

df_table <- df |> 
  mutate(KB_CLASS = cut(KB, breaks = breaks, include.lowest = TRUE))

freq_table <- table(df_table$KB_CLASS, df$SEXO)

percent_table <- round(prop.table(freq_table, margin = 2) * 100, 1)  # % per SEXO

combined <- matrix(
  paste0(freq_table, " (", percent_table, "%)"),
  nrow = nrow(freq_table),
  dimnames = dimnames(freq_table)
)

combined <- rbind(combined, Total = c(colSums(freq_table), sum(freq_table)))

# Crear tabla con kable y kableExtra
kable(combined, 
      caption = "Frequency and Percentage of Head Width by Sex (1-unit bins)", 
      align = "c", 
      format = "html") |> 
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) |> 
  row_spec(0, bold = TRUE) |>
  row_spec(nrow(combined), bold = TRUE, background = "#F5F5F5") |> # Total gris claro
  column_spec(1:3, border_right = TRUE, width = "50mm") |> 
  kable_paper("hover", full_width = FALSE)
```

```{r, echo=FALSE}
ggplot(df, aes(x = SEXO, y = KB, fill = SEXO)) +
  geom_boxplot(color = "black") +
  geom_jitter(aes(col = SEXO), alpha = 0.2) +
  scale_fill_manual(values = c("pink", "skyblue")) +
  labs(title = "Comparison of Head Width by Sex",
       x = "Sex",
       y = "Head Width (KB)") +
  theme_minimal()
```

```{r, echo=FALSE}
ggplot(df, aes(x = SEXO, y = KB, fill = SEXO)) +
  geom_violin(color = "black") +
  geom_jitter(aes(col = SEXO), alpha = 0.2) +
  scale_fill_manual(values = c("pink", "skyblue")) +
  labs(title = "Comparison of Head Width by Sex",
       x = "Sex",
       y = "Head Width (KB)") +
  theme_minimal()
```

```{r, echo=FALSE}
ggplot(df, aes(x = KB, fill = SEXO)) +
  geom_histogram(alpha = 0.6, position = "identity", binwidth = 0.5, color = "black") +
  scale_fill_manual(values = c("pink", "skyblue")) +
  labs(title = "Headh Width Distribution by Sex",
       x = "Head Width (KB)",
       y = "Frequency") +
  theme_minimal()
```

```{r, echo=FALSE}
with(
  df, 
  stby(
    KB,
    SEXO,
    descr
  )
)
```
## Conclusiones

Insertar conclusiones

## Anexo: Código en R

Insertar código