---
title: "Estudio de datos biométricos sobre Lucanus Cervus"
author: 
- Marcelo Atanasio Domínguez Mateo
- Arminda García Moreno
- Alejandro García Prada

date: today
format: 
  html:
    toc: true
    theme: cosmo
  pdf:
    documentclass: article
    number-sections: true
    titlepage: false
    toc-location: before-body
    include-in-header: _extensions/tocdots/tocdots.tex
    toc: true
    toc-title: "Índice"
    geometry:
      - margin=25mm
execute:
  warning: false
  echo: true
---
```{r, echo=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(psych)
library(summarytools)
library(knitr)
library(kableExtra)
library(MASS)
library(GGally)
```

## Objetivos del estudio

El presente estudio se centra en el análisis biométrico del ciervo volante (Lucanus cervus), el mayor escarabajo de Europa, cuya población se ve amenazada por la destrucción de su hábitat natural, los bosques con abundante madera muerta. Este análisis tiene un doble interés: por un lado, evaluar posibles diferencias de tamaño entre machos y hembras; por otro, explorar la relación entre el tamaño de los individuos y la calidad del hábitat de procedencia, ya que se sospecha que en áreas con mayor disponibilidad y calidad de madera muerta los ejemplares alcanzan un mayor desarrollo.

En este marco, el estudio se centra en la medición de la anchura de la cabeza y la longitud de los élitros en un total de 265 ejemplares, seleccionando una muestra representativa de 150 individuos. Se pretende realizar un análisis descriptivo de la anchura de la cabeza, destacando sus principales características y distribuciones dentro de la muestra.

Además, se comparará la anchura de la cabeza entre machos y hembras para identificar diferencias morfológicas relacionadas con el sexo. De manera complementaria, se evaluará si existen variaciones significativas entre ejemplares de distintas procedencias (Asturias, Cantabria y otra), lo que permitirá analizar la influencia del origen geográfico y, por extensión, del hábitat sobre el tamaño de los individuos.

Otro objetivo fundamental es analizar la correlación entre la anchura de la cabeza y la longitud del élitro, primero considerando toda la muestra y posteriormente separando por sexo. Este análisis permitirá determinar si existe una relación proporcional entre estas dos medidas y si dicha relación varía entre hembras y machos.

Finalmente, en los casos en que se identifique una relación significativa entre la anchura de la cabeza y la longitud del élitro para algún sexo, se ajustará un modelo de regresión lineal que explique la variación de la anchura de la cabeza en función de la longitud del élitro, con el objetivo de interpretar cuantitativamente esta relación morfológica y su relevancia biológica.

## Metodología

El estudio se realizó utilizando ejemplares de la colección entomológica del Departamento de Biología de Organismos y Sistemas de la Universidad de Oviedo, incluyendo un total de 265 individuos de ciervo volante (Lucanus cervus), tanto machos como hembras, provenientes de Asturias, Cantabria y otras zonas. Para cada ejemplar se registraron la anchura de la cabeza (KB) y la longitud del élitro (EL) en milímetros, así como el sexo y la provincia de procedencia.

Se seleccionó una muestra aleatoria de 150 individuos para el análisis descriptivo, asegurando que la muestra reflejara adecuadamente la variabilidad de la población. Los datos fueron previamente limpiados y transformados: los valores numéricos fueron convertidos a formato adecuado, se corrigieron inconsistencias y se clasificó la procedencia de los ejemplares en tres categorías: Asturias, Cantabria y otras.

El análisis estadístico incluyó la obtención de medidas de tendencia central y de dispersión para la anchura de la cabeza y la longitud del élitro, con el fin de caracterizar la muestra. Se realizaron comparaciones de la anchura de la cabeza entre machos y hembras y entre ejemplares de distintas procedencias mediante tablas de frecuencia, gráficos de barras, boxplots y violín plots.

Se analizó la relación entre la anchura de la cabeza y la longitud del élitro mediante coeficientes de correlación para toda la muestra y por sexo, con el objetivo de identificar posibles asociaciones morfológicas. En los casos en los que se detectó una correlación significativa, se ajustó un modelo de regresión lineal para explicar la variación de la anchura de la cabeza en función de la longitud del élitro y se interpretaron los parámetros obtenidos en términos biológicos.

Para la visualización de los datos y la generación de gráficos se utilizó el software R, empleando principalmente los paquetes ggplot2 y summarytools. Se elaboraron histogramas, boxplots, violín plots y tablas descriptivas que permitieron explorar la distribución de las variables, identificar diferencias entre grupos y mostrar la relación entre la anchura de la cabeza y la longitud del élitro de manera clara y reproducible.

## Resultados
### Análisis descriptivo de todos los ejemplares
```{r, echo=FALSE}
lab <- read.table(file = "data/lucanus.csv", header = TRUE, fill = TRUE)

lab <- lab |>
  mutate(
      KB = as.numeric(gsub(",", ".", trimws(KB))),
      EL = as.numeric(gsub(",", ".", trimws(EL))),
      SEXO = as.factor(trimws(SEXO)),
      PROVINCIA = ifelse(trimws(PROVINCIA) == "", "Otras", trimws(PROVINCIA)),
      PROVINCIA = as.factor(trimws(PROVINCIA))
  )

summary(lab)
```
Se comenzó con el procesamiento y limpieza de los datos de los 265 ejemplares de Lucanus cervus. Para cada individuo se registraron la anchura de la cabeza (KB), la longitud de los élitros (EL), el sexo y la provincia de procedencia (Asturias, Cantabria u otras). Se verificaron los formatos de las variables, se corrigieron inconsistencias y se prepararon los datos para el análisis posterior.

### Análisis descriptivo de una muestra de 150 ejemplares
```{r, echo=FALSE}
set.seed(42)
df <- lab |> 
  slice_sample(n = 150, replace = FALSE)
summary(df)
```
Para realizar un análisis más detallado, se seleccionó aleatoriamente una muestra de 150 ejemplares a partir de los 265 disponibles, asegurando que se conservara la variabilidad de la población original en términos de sexo, procedencia y medidas morfológicas.

En esta muestra, la anchura de la cabeza (KB) presentó valores entre 7,20 y 22,90 mm, con una mediana de 10,90 mm y un promedio de 11,95 mm, ligeramente inferior al promedio de toda la población (12,04 mm) pero similar en su mediana (10,70 mm). La longitud de los élitros (EL) varió entre 15,30 y 27,80 mm, con una mediana de 20,60 mm y una media de 20,72 mm, valores próximos a los observados en todos los ejemplares (mediana 20,70 mm, media 20,91 mm).

En cuanto al sexo, la muestra incluyó 67 hembras y 83 machos, manteniendo una proporción similar a la de la población completa. Respecto a la procedencia, 105 ejemplares eran de Asturias, 17 de Cantabria y 28 de otras zonas, reflejando también la distribución general de los 265 individuos.

Comparando esta muestra con la población total, se observa que las medidas de tendencia central y la dispersión se conservan, lo que confirma que la muestra es representativa y adecuada para los análisis posteriores. La selección aleatoria permite que los resultados de esta muestra reflejen fielmente las características morfológicas y la variabilidad de la especie en el conjunto de la colección.
```{r, echo=FALSE}
summary(df$KB)
```
### Análisis de la anchura de la cabeza
```{r, echo=FALSE}
  ggplot(df, aes(x = KB)) +
    geom_histogram(binwidth = 0.5, fill = "skyblue",color = "black") +
    labs(title = "Head Width Distribution",
         x = "Head Width (KB)",
         y = "Frequency")
```

```{r, echo=FALSE}
ggplot(df, aes(x = as.factor("1"), y = KB)) +
  geom_boxplot(fill = "skyblue", color = "black", width = 0.3) +
  labs(title = "Boxplot de Head Width",
       x = "",
       y = "Head Width (KB)") +
  theme(axis.text.x = element_blank())
```

### Comparación de la Cabeza entre las Provincias
```{r, echo=FALSE}
# create intervals
df$KB_cut <- cut(
  df$KB,
  breaks = seq(7,25,by=2),
  include.lowest = TRUE,
  right = FALSE
)
```

```{r, echo=FALSE}
# create frequency table
freq_table <- table(df$KB_cut, df$PROVINCIA)

# calculate percentages per column
percent_table <- round(prop.table(freq_table, margin = 2) * 100, 1)

# combine frecuency and percentages in "freq (pct%)" format
combined <- matrix(
  paste0(freq_table, " (", percent_table, "%)"),
  nrow = nrow(freq_table),
  dimnames = dimnames(freq_table)
)

# add "total" row
combined <- rbind(combined, Total = colSums(freq_table))

# create HTML table with kableExtra
kable(combined, 
      caption = "Frequency and Percentage of KB by Province", 
      align = "c", 
      format = "html") |>
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) |>
  row_spec(0, bold = TRUE) |>  # header in bold
  row_spec(nrow(combined), bold = TRUE, background = "#F5F5F5") |>
  column_spec(1:ncol(combined), border_right = TRUE, width = "50mm") |> 
  kable_paper("hover", full_width = FALSE)
```

```{r, echo=FALSE}
df |>
  ggplot(aes(x = KB)) +
  geom_histogram(
    color = "black",
    alpha = 0.7,
    breaks = seq(7,25,by=2),
    fill = "skyblue"
  ) +
  scale_x_continuous(breaks = seq(7,25,by=2)) +
  theme_bw() +
  labs(
    x = "KB",
    y = "Frequency",
    title = "KB distribution by province"
  ) +
  facet_wrap(~ PROVINCIA, ncol = 1)
```
```{r, echo=FALSE}
df |>
  ggplot(aes(x = KB)) +
  geom_density(
    color = "black",
    alpha = 0.7,
    fill = "skyblue"
  ) +
  scale_x_continuous(breaks = seq(7,25,by=2)) +
  theme_bw() +
  labs(
    x = "KB",
    y = "Frequency",
    title = "KB density plot by province"
  ) +
  facet_wrap(~ PROVINCIA, ncol = 1)
```

```{r, echo=FALSE}
df |>
  ggplot(aes(x = PROVINCIA, y = KB, fill = PROVINCIA)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.6) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.3) +
  scale_fill_manual(values = c("#c6dbef", "#9ecae1", "#6baed6")) +
  theme_bw() +
  labs(
    x = "Province",
    y = "Head Width (KB)",
    title = "Comparison of head width between provinces",
    fill = "Province"
  )
```

```{r, echo=FALSE}
ggplot(df, aes(x = PROVINCIA, y = KB, fill = PROVINCIA)) +
  geom_violin(trim = FALSE, color = "black", alpha = 0.6) + 
  geom_jitter(width = 0.15, size = 1.5, alpha = 0.3, color = "black") +  # points
  scale_fill_manual(values = c("#c6dbef", "#9ecae1", "#6baed6")) +
  theme_bw() +
  labs(
    x = "Province",
    y = "Head Width (KB)",
    title = "Violin Plot of KB by Province",
    fill = "Province"
  )

```

```{r, echo=FALSE}
with(
  df, 
  stby(
    KB, 
    PROVINCIA, 
    descr
  )
)
```


### Comparar la anchura de la cabeza de las hembras con la de los machos.
```{r, echo=FALSE}
breaks <- seq(floor(min(df$KB)), ceiling(max(df$KB)), by = 1)

df_table <- df |> 
  mutate(KB_CLASS = cut(KB, breaks = breaks, include.lowest = TRUE))

freq_table <- table(df_table$KB_CLASS, df$SEXO)

percent_table <- round(prop.table(freq_table, margin = 2) * 100, 1)  # % per SEXO

combined <- matrix(
  paste0(freq_table, " (", percent_table, "%)"),
  nrow = nrow(freq_table),
  dimnames = dimnames(freq_table)
)

combined <- rbind(combined, Total = c(colSums(freq_table), sum(freq_table)))

# Crear tabla con kable y kableExtra
kable(combined, 
      caption = "Frequency and Percentage of Head Width by Sex (1-unit bins)", 
      align = "c", 
      format = "html") |> 
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) |> 
  row_spec(0, bold = TRUE) |>
  row_spec(nrow(combined), bold = TRUE, background = "#F5F5F5") |> # Total gris claro
  column_spec(1:3, border_right = TRUE, width = "50mm") |> 
  kable_paper("hover", full_width = FALSE)
```

```{r, echo=FALSE}
ggplot(df, aes(x = SEXO, y = KB, fill = SEXO)) +
  geom_boxplot(color = "black") +
  geom_jitter(aes(col = SEXO), alpha = 0.2) +
  scale_fill_manual(values = c("pink", "skyblue")) +
  labs(title = "Comparison of Head Width by Sex",
       x = "Sex",
       y = "Head Width (KB)") +
  theme_minimal()
```

```{r, echo=FALSE}
ggplot(df, aes(x = SEXO, y = KB, fill = SEXO)) +
  geom_violin(color = "black") +
  geom_jitter(aes(col = SEXO), alpha = 0.2) +
  scale_fill_manual(values = c("pink", "skyblue")) +
  labs(title = "Comparison of Head Width by Sex",
       x = "Sex",
       y = "Head Width (KB)") +
  theme_minimal()
```

```{r, echo=FALSE}
ggplot(df, aes(x = KB, fill = SEXO)) +
  geom_histogram(alpha = 0.6, position = "identity", binwidth = 0.5, color = "black") +
  scale_fill_manual(values = c("pink", "skyblue")) +
  labs(title = "Headh Width Distribution by Sex",
       x = "Head Width (KB)",
       y = "Frequency") +
  theme_minimal()
```

```{r, echo=FALSE}
with(
  df, 
  stby(
    KB,
    SEXO,
    descr
  )
)
```

### Correlación entre la anchura de la cabeza y la longitud del élitro

```{r, echo=FALSE}
df |> dplyr::select(where(is.numeric)) |>  
  drop_na() |>  # removes rows with NA values
    cov() |>  # cov matrix
      round(2) 
```

La tabla creada anteriormente es lo que se conoce como matriz de covarianzas, la cual ayuda en el estudio de la covarianza entre variables (2 o más). En este caso, es una matriz que relaciona las variables KB y EL.

En este tipo de matrices, las diagonales indican la varianza de cada variable. Por ello se obtiene que la Var(KB) = 14.28 y que la Var(EL) = 6.05. Es decir, KB varía mucho más que EL. Esto es debido a que en la muestra escogida los valores de KB tienen mayor dispersión (varían más) que los valores de EL. 

Por otro lado, el resto de variables indican la covarianza entre la variable fila y la variable columna. En este caso, al solo tener dos variables se obtiene la covarianza de KB y EL es 8.20.

Al ser un valor positivo de covarianza se puede afirmar que, cuando una de las variables crece, la otra también lo hace. Es decir, la anchura de la cabeza crece con la longitud de las elitros y viceversa.

El problema cae en que la anchura de la cabeza y la longitud de las elitros se miden en magnitudes diferentes, por ello no se puede determinar el coeficiente de correlación de los datos. Por lo que esta matriz sólo sirve para estudiar la tendencia y el sentido de la relación entre KB y EL.

```{r, echo=FALSE}
cor(x = df$KB, y = df$EL) # correlation of KB and EL (general)
```

El coeficiente de correlación se calcula normalizando los datos. En este caso, se calcula mediante la función de R cor(x,y), la cual calcula la correlación de Pearson.

Calculada la correlación entre KB y EL, el valor obtenido es 0.88. Con este valor se puede llegar a la misma conclusión anterior: al ser un valor próximo a 1, se deduce que existe una relación y que esta es positiva (tendencia y sentido hablado anteriormente). Lo que aporta el coeficiente de correlación es la magnitud de la relación y, en este caso, 0.88 es un valor bastante alto (recordemos que está entre -1 y 1), lo cual indica una correlación fuerte entre las variables.

```{r, echo=FALSE}
ggplot(data = df, aes(x = KB, y = EL)) +
  geom_point()
```

### Correlación entre la anchura de la cabeza y la longitud del élitro (para cada sexo)
```{r, echo=FALSE}
ggpairs(
    df |> dplyr::select(KB, EL, SEXO),
    aes(col = SEXO),
    diag = list(continuous = wrap("densityDiag")),
    lower = list(continuous = wrap("points")),
    upper = list(continuous = wrap("cor"))
)
```

### Recta de regresión de la anchura de la cabeza en función de la longitud del élitro (para los sexos donde estén relacionadas)
Male
```{r, echo=FALSE}
male_data <- df |> 
  filter(SEXO == "macho")

male_cor <- cor(x = male_data$KB, y = male_data$EL) # correlation of KB and EL
```

```{r, echo=FALSE}
if (male_cor > 0.5){ # 0.5 = umbral (moderate) to be consider the relation
  male_data |> 
    dplyr::select(KB, EL) |> 
      ggplot(aes(x = EL, y = KB)) +  
      geom_point() +  
      geom_smooth(method = lm, se = FALSE, formula = y ~ x) +  
      theme_bw()
} else {
  print("No relation (male)")
}
```

```{r, echo=FALSE}
if (male_cor > 0.5){
  # lm = linear model (between KB, EL with the data)
  summary(lm(KB ~ EL, data = male_data))
}
```

Female
```{r, echo=FALSE}
female_data <- df |> 
  filter(SEXO == "hembra")

female_cor <- cor(x = female_data$KB, y = female_data$EL)
```

```{r, echo=FALSE}
if (female_cor > 0.5){
  female_data |> 
    dplyr::select(KB, EL) |> 
      ggplot(aes(x = EL, y = KB)) +  
      geom_point() +  
      geom_smooth(method = lm, se = FALSE, formula = y ~ x) +  
      theme_bw() 
} else {
  print("No relation (female)")
}
```

```{r, echo=FALSE}
if (female_cor > 0.5){
  summary(lm(KB ~ EL, data = female_data))
}
```

## Conclusiones

Insertar conclusiones

## Anexo: Código en R

Insertar código